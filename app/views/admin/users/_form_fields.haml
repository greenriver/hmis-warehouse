- user = f.object
.row
  .col-sm-6
    %h3 User Information
    - providers = user.oauth_identities.map(&:provider_name).sort.uniq
    - if providers.any?
      .alert.alert-info
        = "Sign-in provided by #{providers.to_sentence}. Changes made here to personal information may be overwritten on the user's next login."
    .form-inputs.well
      .row
        .col-sm-10
          = f.input :first_name, required: true
      .row
        .col-sm-10
          = f.input :last_name, required: true
      .row
        .col-sm-8
          = f.input :email, as: :email, required: true
      - if Talentlms::Config.any?
        .row
          .col-sm-8
            = f.input :talent_lms_email, as: :email
      .row
        .col-sm-4
          = f.input :phone
      - if user.show_credentials?
        .row
          .col-sm-10
            = f.input :credentials, label: 'Credentials', collection: @user.credential_options, as: :select_two, input_html: { data: {tags: true} }, hint: 'Add a new credential type by typing the name and hitting enter.'
      .row
        .col-sm-10
          = f.input :agency_id, collection: @agencies, label_method: :name, value_method: :id, include_blank: true, as: :select_two, required: true
      .row
        .col-sm-10
          = f.input :exclude_from_directory
      .row
        .col-sm-10
          = f.input :exclude_phone_from_directory
      -# Allow skipping email invite for new users if OKTA is enabled. The first time they log in with okta, the account will get linked.
      - if ENV['OKTA_DOMAIN'].present? && @user.new_record?
        .row
          .col-sm-10
            = f.input :skip_invitation, as: :boolean, label: 'Skip email invitation'
      - if @user.two_factor_enabled?
        .row
          .col-sm-8
            %p This user has enabled Two-Factor authentication.  If this is preventing login, you can turn it off below.  Before you do, you should ensure the request is coming from the actual user.  Once off, the user will need to re-enable it.
            = f.input :otp_required_for_login, as: :select_two, label: 'Require two-factor authentication', include_blank: false, input_html: {class: [:j2Fa]}

  .col-sm-6
    .form--checkbox-groups
      %h3 Notifications
      .well
        %p Which notifications should this user receive?
        - if ENV['OKTA_DOMAIN'].present?
          = f.input :notify_on_new_account, label: 'New account creation by an external system'
        = f.input :receive_file_upload_notifications, label: 'File uploads'
        - if can_edit_vspdat? # you can only assign this if you can also edit them
          = f.input :notify_on_vispdat_completed, label: "VI-SPDAT submissions", as: :boolean
        - if GrdaWarehouse::DataSource.authoritative.exists?
          = f.input :notify_on_client_added, label: "Authoritative clients added", as: :boolean
        = f.input :notify_on_anomaly_identified, label: "Anomalies identified"
        - if GrdaWarehouse::Config.get(:request_account_available)
          = f.input :receive_account_request_notifications, label: 'Account requests', as: :boolean
    .form--expiration
      %h3 Account Life-cycle
      .well
        = f.input :expired_at, as: :date_picker, label: 'Account Expiration Date', hint: 'If an expiration date is present, the user will not be able to login after that date.  Active accounts should be blank.'
    .form-access-control
      %h3 Permission Scheme
      .well
        = f.input :permission_context, as: :select_two, label: 'Permission Version', hint: 'Unless you know what you are doing, you should leave this as "Role-Based Access" for the time-being.', collection: User.available_permission_contexts.invert, include_blank: false

    - if @user.training_required?
      .form--user-training
        %h3 User Training
        .well
          = f.input :training_courses, as: :select_two, label: 'Required Courses', hint: "The default courses (#{Talentlms::Course.default.map(&:name).join(', ')}) will be required if no course is selected.", collection: Talentlms::Course.collection_for_form, input_html: { multiple: true }
          %p Course Progress:
          -@user.required_training_courses.each do |course|
            .row
              .col-sm-6= course.name_with_subdomain
              .col-sm-6= @user.training_status(course)
          .row
            .col-sm-2
              - unless @user.last_training_completed.present?
                = f.input :training_completed, label: 'Check to OVERRIDE course completion requirement'
    - if RailsDrivers.loaded.include?(:superset) && Superset.available?
      .form-access-control
        %h3 OP Analytics Superset Configuration
        .well
          = f.input :superset_roles, as: :select_two, collection: Superset.available_superset_roles, label: 'Superset Role', hint: 'These roles will be used for this user when the login to Superset. If no role is specified the default "Report Runner" role will be assigned on first login. Role changes only take effect on the next Superset login.', input_html: { multiple: true }

= render '/users/user_viewable_entities', f: f, roles: Role.editable.order(:name)
