language: ruby
cache: bundler

bundler_args: --without production staging development

before_script:
  - cp config/letsencrypt_plugin.yml.sample config/letsencrypt_plugin.yml
  - cp config/secrets.yml.sample config/secrets.yml
  - mkdir app/assets/stylesheets/theme/styles
  - touch app/assets/stylesheets/theme/styles/_variables.scss
  - cp .rspec.travis .rspec

env:
  - RAILS_ENV=test DATABASE_ADAPTER=postgresql WAREHOUSE_DATABASE_ADAPTER=postgresql HEALTH_DATABASE_ADAPTER=postgresql DATABASE_APP_DB_TEST=boston_hmis_test WAREHOUSE_DATABASE_DB_TEST=warehouse_test HEALTH_DATABASE_DB_TEST=health_test DEFAULT_FROM=greenriver.testing@mailinator.com HEALTH_FROM=greenriver.testing@mailinator.com HOSTNAME=openpath.host FQDN=openpath.host PORT=80 REPORTING_DATABASE_ADAPTER=postgresql REPORTING_DATABASE_DB_TEST=test_boston_reporting DATABASE_WAREHOUSE_DB_TEST=test_hmis_warehouse CLIENT=test ENCRYPTION_KEY=strongEncryptionstrongEncryptionstrongEncryption

script:
  - date
  - bundle exec rake db:create
  - bundle exec rake warehouse:db:create
  - bundle exec rake health:db:create
  - bundle exec rake reporting:db:create
  - bundle exec rake db:schema:load
  - bundle exec rake warehouse:db:schema:load
  - bundle exec rake health:db:schema:load
  - bundle exec rake reporting:db:schema:load
  - bundle exec brakeman -q --ensure-latest
  - bundle exec bundle-audit check --update --ignore CVE-2019-16676 CVE-2017-1002201
  - npm install
  - bundle exec rspec

addons:
  postgresql: "9.5"
  apt_packages:
    libmagic-dev

before_install:
  - gem uninstall -v '>= 2' -i $(rvm gemdir)@global -ax bundler || true
  - gem install bundler -v '< 2'

matrix:
  fast_finish: true