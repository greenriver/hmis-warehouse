{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "additionalProperties": false,
  "title": "Form Definition",
  "type": "object",
  "unevaluatedProperties": false,
  "required": [ "item" ],
  "properties": {
    "name": { "type": "string" },
    "item": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/form_node" }
    }
  },
  "$defs": {
    "mapping": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "_comment": { "type": "string" },
        "record_type": { "type": "string" },
        "field_name": { "type": "string" },
        "custom_field_key": { "type": "string" }
      }
    },
    "pick_list_option": {
      "type": "object",
      "additionalProperties": false,
      "required": [ "code" ],
      "properties": {
        "code": { "type": "string" },
        "label": { "type": "string" },
        "secondary_label": { "type": "string" },
        "group_code": { "type": "string" },
        "group_label": { "type": "string" },
        "helper_text": { "type": "string" },
        "numeric_value": { "type": "integer" },
        "initial_selected": { "type": "string" }
      }
    },
    "bounds": {
      "type": "object",
      "additionalProperties": false,
      "required": [ "id", "type" ],
      "properties": {
        "_comment": { "type": "string" },
        "id": { "type": "string" },
        "type": { "type": "string" },
        "question": { "type": "string" },
        "value_local_constant": { "type": "string" },
        "value_number": { "type": "integer" },
        "offset": { "type": "integer" },
        "severity": { "enum": [ "error", "warning" ] }
      }
    },
    "rule": {
      "type": "object",
      "required": [ "operator" ],
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "operator": { "enum": [ "ANY", "ALL" ] },
            "parts": { "type": "array", "items": { "$ref": "#/$defs/rule" } }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "variable": { "enum": [ "projectId" ] },
            "operator": { "enum": [ "EQUAL", "NOT_EQUAL" ] },
            "value": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "variable": { "enum": [ "projectType" ] },
            "operator": { "enum": [ "EQUAL", "NOT_EQUAL" ] },
            "value": {
              "type": "integer",
              "enum": [
                0, 1, 2, 3, 4, 6, 8, 9, 7, 10, 11, 12, 13, 14
              ]
            }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "variable": { "enum": [ "projectFunderComponents" ] },
            "operator": { "enum": [ "INCLUDE", "NOT_INCLUDE" ] },
            "value": { "type": "string", "enum": [
                "HHS: PATH",
                "HHS: RHY",
                "HUD: CoC",
                "HUD: ESG",
                "HUD: ESG RUSH",
                "HUD: HOPWA",
                "HUD: HUD-VASH",
                "HUD: PFS",
                "HUD: Rural Special NOFO",
                "HUD: Unsheltered Special NOFO",
                "VA: CRS Contract Residential Services",
                "VA: Community Contract Safe Haven",
                "VA: GPD",
                "VA: SSVF"
              ] }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "variable": { "enum": [ "projectOtherFunders" ] },
            "operator": { "enum": [ "INCLUDE", "NOT_INCLUDE" ] },
            "value": { "type": "string" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "_comment": { "type": "string" },
            "variable": { "enum": [ "projectFunders" ] },
            "operator": { "enum": [ "INCLUDE", "NOT_INCLUDE" ] },
            "value": { "type": "integer", "enum": [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 30, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55 ] }
          }
        }
      ]
    },
    "initial": {
      "type": "object",
      "additionalProperties": false,
      "required": [ "initial_behavior" ],
      "properties": {
        "_comment": { "type": "string" },
        "initial_behavior": { "type": "string" },
        "value_local_constant": { "type": "string" },
        "value_code": { "type": "string" },
        "value_number": { "type": "integer" },
        "value_boolean": { "type": "boolean" }
      }
    },
    "enable_when": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "_comment": { "type": "string" },
        "question": { "type": "string" },
        "compare_question": { "type": "string" },
        "local_constant": { "type": "string" },
        "operator": { "type": "string" },
        "answer_code": { "type": "string" },
        "answer_codes": { "type": "array", "items": { "type": "string" } },
        "answer_number": { "type": "integer" },
        "answer_boolean": { "type": "boolean" },
        "answer_group_code": { "type": "string" }
      }
    },
    "autofill_values": {
      "type": "object",
      "unevaluatedProperties": false,
      "required": [ "autofill_behavior", "autofill_when" ],
      "properties": {
        "_comment": { "type": "string" },
        "value_code": { "type": "string" },
        "value_number": { "type": "integer" },
        "value_boolean": { "type": "boolean" },
        "value_question": { "type": "string" },
        "autofill_readonly": { "type": "boolean" },
        "autofill_behavior": { "type": "string" },
        "autofill_when": { "type": "array", "items": { "$ref": "#/$defs/enable_when" } },
        "formula": { "type": "string" },
        "sum_questions": { "type": "array", "items": { "type": "string" } }
      }
    },

    "form_node": {
      "type": "object",
      "properties": { "type": { "enum":
          [
            "BOOLEAN",
            "CHOICE",
            "CURRENCY",
            "DATE",
            "DISPLAY",
            "FILE",
            "GROUP",
            "IMAGE",
            "INTEGER",
            "OBJECT",
            "OPEN_CHOICE",
            "STRING",
            "TEXT",
            "TIME_OF_DAY"
          ]
        }
      },
      "allOf": [
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "BOOLEAN" } }
          },
          "then": { "$ref": "#/$defs/boolean_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "CHOICE" } }
          },
          "then": { "$ref": "#/$defs/choice_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "CURRENCY" } }
          },
          "then": { "$ref": "#/$defs/currency_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "DATE" } }
          },
          "then": { "$ref": "#/$defs/date_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "DISPLAY" } }
          },
          "then": { "$ref": "#/$defs/display_form_node" }
        },
        {
          "if": { "properties": {
              "required": [ "type" ],
              "type": { "const": "FILE" } }
          },
          "then": { "$ref": "#/$defs/file_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "GROUP" } }
          },
          "then": { "$ref": "#/$defs/group_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "IMAGE" } }
          },
          "then": { "$ref": "#/$defs/image_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "INTEGER" } }
          },
          "then": { "$ref": "#/$defs/integer_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "OBJECT" } }
          },
          "then": { "$ref": "#/$defs/object_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "OPEN_CHOICE" } }
          },
          "then": { "$ref": "#/$defs/open_choice_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "STRING" } }
          },
          "then": { "$ref": "#/$defs/string_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "TEXT" } }
          },
          "then": { "$ref": "#/$defs/string_form_node" }
        },
        {
          "if": {
            "required": [ "type" ],
            "properties": { "type": { "const": "TIME_OF_DAY" } }
          },
          "then": { "$ref": "#/$defs/time_of_day_form_node" }
        }
      ]
    },

    "boolean_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },

    "choice_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" },
        {
          "type": "object",
          "oneOf": [
            { "required": [ "pick_list_reference" ] },
            { "required": [ "pick_list_options" ] }
          ],
          "properties": {
            "pick_list_reference": { "type": "string" },
            "pick_list_options": {
              "type": "array",
              "items": { "$ref": "#/$defs/pick_list_option" }
            },
            "component": {
              "enum": [
                "CHECKBOX",
                "DROPDOWN",
                "RADIO_BUTTONS",
                "RADIO_BUTTONS_VERTICAL"
              ]
            }
          }
        }
      ]
    },
    "currency_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },
    "date_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },
    "display_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/base_form_node" }
      ]
    },
    "file_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },
    "group_form_node": {
      "$comment": "Group form nodes",
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/base_form_node" },
        {
          "type": "object",
          "required": [ "type", "item" ],
          "properties": {
            "type": { "const": "GROUP" },
            "component": { "enum": [
              "DISABILITY_TABLE",
              "HORIZONTAL_GROUP",
              "INFO_GROUP",
              "INPUT_GROUP"
              ] },
            "item": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/$defs/form_node" }
            },
            "text": { "type": "string" },
            "data_collected_about": {
              "enum": [
                "ALL_CLIENTS",
                "ALL_VETERANS",
                "HOH",
                "HOH_AND_ADULTS",
                "VETERAN_HOH"
              ]
            }
          }
        }
      ]
    },
    "image_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },

    "integer_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },

    "object_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/base_form_node" },
        {
          "properties": {
            "type": { "const": "OBJECT" },
            "hidden": { "type": "boolean" },
            "prefix": { "type": "string" },
            "brief_text": { "type": "string" },
            "text": { "type": "string" },
            "readonly_text": { "type": "string" },
            "helper_text": { "type": "string" },
            "required": { "type": "boolean" },
            "assessment_date": { "type": "boolean" },
            "read_only": { "type": "boolean" },
            "warn_if_empty": { "type": "boolean" },
            "pick_list_reference": { "type": "string" },
            "mapping": { "$ref": "#/$defs/mapping" },
            "project_types_excluded": { "type": "array", "items": { "type": "string" } },
            "bounds": { "type": "array", "items": { "$ref": "#/$defs/bounds" } },
            "repeats": { "type": "boolean" },
            "size": { "type": "string" },
            "service_detail_type": { "type": "string" },
            "initial": { "type": "array", "items": { "$ref": "#/$defs/initial" } },
            "component": {
              "enum": [
                "NAME",
                "ADDRESS",
                "PHONE",
                "EMAIL"
              ]
            },
            "autofill_values": {
              "type": "array",
              "items": { "$ref": "#/$defs/autofill_values" }
            }
          }
        }
      ]
    },

    "open_choice_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },
    "string_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" },
        {
          "type": "object",
          "properties": {
            "component": { "enum": [ "EMAIL", "PHONE", "SSN" ] }
          }
        }
      ]
    },
    "time_of_day_form_node": {
      "unevaluatedProperties": false,
      "allOf": [
        { "$ref": "#/$defs/input_form_node" }
      ]
    },
    "input_form_node": {
      "$comment": "Base properties for form inputs",
      "type": "object",
      "allOf": [
        { "$ref": "#/$defs/base_form_node" },
        {
          "$comment": "Inputs must have a text field unless hidden",
          "if": {
            "not": {
              "properties": { "hidden": { "const": true } },
              "required": [ "hidden" ]
            }
          },
          "then": { "required": [ "text" ] }
        },
        {
          "properties": {
            "hidden": { "type": "boolean" },
            "prefix": { "type": "string" },
            "brief_text": { "type": "string" },
            "text": { "type": "string" },
            "readonly_text": { "type": "string" },
            "helper_text": { "type": "string" },
            "required": { "type": "boolean" },
            "assessment_date": { "type": "boolean" },
            "read_only": { "type": "boolean" },
            "warn_if_empty": { "type": "boolean" },
            "mapping": { "$ref": "#/$defs/mapping" },
            "project_types_excluded": { "type": "array", "items": { "type": "string" } },
            "bounds": { "type": "array", "items": { "$ref": "#/$defs/bounds" } },
            "repeats": { "type": "boolean" },
            "size": { "type": "string" },
            "service_detail_type": { "type": "string" },
            "initial": { "type": "array", "items": { "$ref": "#/$defs/initial" } },
            "autofill_values": {
              "type": "array",
              "items": { "$ref": "#/$defs/autofill_values" }
            }
          }
        }
      ]
    },
    "base_form_node": {
      "type": "object",
      "$comment": "Base properties for all form nodes",
      "required": [ "link_id" ],
      "properties": {
        "_comment": { "type": "string" },
        "link_id": { "type": "string" },
        "hidden": { "type": "boolean" },
        "enable_behavior": { "enum": [ "ALL", "ANY" ] },
        "enable_when": { "type": "array", "items": { "$ref": "#/$defs/enable_when" } },
        "rule": { "$ref": "#/$defs/rule" },
        "disabled_display": { "type": "string" }
      }
    }
  }
}
