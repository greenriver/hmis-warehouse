- label = @report.detail_denominator_label_for(key)
.d-flex.justify-content-around.mb-4
  - if label.present? && show_label_detail
    .col-4
      = render 'warehouse_reports/indicator', indicator: @report.detail_indicator_result(result, key)
    .col-8.d-flex.justify-content-end.pr-0
      .col-6
        .c-chart--vertical-bar{ class: class_name, data: { chart: result.data_for_system_level_bar.to_json }}
      .col-5.d-flex.align-items-center.mb-6.pr-0
        .card.p-3
          .mb-6.d-flex
            .mr-2 #{result.report_year}:
            %div
              %strong= result.reporting_numerator
              of
              = label
              %strong= result.reporting_denominator
          .mb-0.d-flex
            .mr-2 #{result.comparison_year}:
            %div
              %strong= result.comparison_numerator
              of
              = label
              %strong= result.comparison_denominator
  - else
    .col-6
      = render 'warehouse_reports/indicator', indicator: @report.detail_indicator_result(result, key)
    .col-5
      .c-chart--vertical-bar{ class: class_name, data: { chart: result.data_for_system_level_bar.to_json }}
    .col-1

= content_for :page_js do
  :javascript
    $(document).ready(function() {
      const data = $('.#{class_name}').data('chart');
      const max = Math.max(...data.columns[1].slice(1));
      const includePercent = #{result.percentage?};
      const goal = #{@report.detail_goal_for_reference_line(key).to_json};
      const axisMax = max < goal && goal !== null ? goal : undefined;
      const tooltipTitles = #{result.titles_for_system_level_bar_tooltip.to_json.html_safe}

      data.labels.format = function (v, id, i, texts) {
        if (v < (axisMax || max) * 0.15) {
          return '';
        }
        if (includePercent) {
          return d3.format(".0%")(v / 100);
        } else {
          return d3.format(",d")(v);
        }
      }

      const chart = bb.generate({
        data: data,
        axis: {
          rotated: includePercent,
          x: { type: 'category' },
          y: {
            tick: {
              stepSize: 1,
              count: 3,
              format: function(x) { return `${d3.format('d')(x)}${includePercent ? '%' : ''}`}
            },
            ...(axisMax && { max: axisMax }),
          },
        },
        size: { height: 150 },
        legend: { show: false },
        tooltip: {
          contents: (d, defaultTitleFormat, defaultValueFormat, color) => {
            return _tooltip(d, defaultTitleFormat, defaultValueFormat, color, tooltipTitles, goal)
          },
        },
        ...(goal !== null && {
          grid: {
            lines: { front: false },
            y: { lines: [{ value: goal }] } }
        }),
        bindto: '.#{class_name}'
      });
      d3.select('.#{class_name} .bb-ygrid-line line').style('stroke-width', 2)
      d3.select('.#{class_name} .bb-ygrid-line line').style('stroke-dasharray', 2)
    });

    function _tooltip(d, defaultTitleFormat, defaultValueFormat, color, tooltipTitles, goal) {
      const data = d[0];

      // Build ratio description
      let description = '';
      const denominatorLabel = "#{@report.detail_denominator_label_for(key)}";
      if (denominatorLabel) {
        const numer = data.index === 0 ? "#{result.reporting_numerator}" : "#{result.comparison_numerator}";
        const denom = data.index === 0 ? "#{result.reporting_denominator}" : "#{result.comparison_denominator}";
        description = ` (${numer} of ${denominatorLabel} ${denom})`;
      }

      let html = "<table class='bb-tooltip' style='opacity: 1;'>";
      html += "<thead>";
      html += `<tr><th colspan="3">${tooltipTitles[data.index]}</th></tr>`
      if (goal) html += `<tr><th></th><th>Value</th><th>Goal</th></tr>`;
      html += "</thead>";
      html += "<tbody>";

      const bg_color = color(data.id);
      const box = `<td style='white-space: nowrap;'><svg><rect style='fill:${bg_color}' width='10' height='10'></rect></svg>${data.name}</td>`;
      const value = `<td style='white-space: nowrap;'>${defaultValueFormat(data.value)}${description}</td>`;
      html += box;
      html += value;
      if (goal)
        html += `<td style='white-space: nowrap;'>${defaultValueFormat(goal)}</td>`;
      html += "</tr>";
      html += "</tbody>";
      html += '</table>';
      return html;
    }
